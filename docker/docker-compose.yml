# This docker-compose is used for DEV purposes.
# It consists also of deploy script with volume mounting to the host:
#  thus, you your deployments/<>.json might be changed after contract redeployed.
#
# To use from ../: `docker compose -f ./docker/docker-compose.yml up`.
# Note, if you changed contracts and what to use docker-compose instead of local make command to deploy
#  - you should rebuild with --build flag.
# Note, deploy may take some time, check logs.
services:
  # Anvil node with deployed contracts
  chain-rpc:
    image: ${CHAIN_RPC_IMAGE:-chain-rpc}
    build:
      context: ../
      dockerfile: ./docker/Dockerfile
      target: chain-rpc
    ports:
      - "8545:8545"

  deal-deploy-script:
    image: ${DEAL_DEPLOY_SCRIPT_IMAGE:-deal-deploy-script}
    build:
      context: ../
      dockerfile: ./docker/Dockerfile
      target: deal-deploy-script
    depends_on:
      - chain-rpc
    volumes:
      - ../deployments:/app/deployments

  # Blockscout services
  blockscout:
    depends_on:
      - chain-rpc
    image: offchainlabs/blockscout:v1.0.0-c8db5b1
    restart: always
    links:
      - postgres:database
    command:
      - /bin/sh
      - -c
      - |
        bin/blockscout eval "Elixir.Explorer.ReleaseTasks.create_and_migrate()"
        node init/install.js postgres 5432
        bin/blockscout start
    environment:
      ETHEREUM_JSONRPC_VARIANT: "geth"
      ETHEREUM_JSONRPC_HTTP_URL: http://anvil-node:8545/
      ETHEREUM_JSONRPC_TRACE_URL: http://anvil-node:8545/
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
      DATABASE_URL: postgresql://postgres:@postgres:5432/blockscout
      ECTO_USE_SSL: "false"
      NETWORK: ""
      SUBNETWORK: "Fluence Local Network"
      BLOCKSCOUT_VERSION: "Fluence Local Network 0.0.1"
      PORT: 4000
    ports:
      - "127.0.0.1:4000:4000"

  postgres:
    image: postgres:13.6
    restart: always
    environment:
      POSTGRES_PASSWORD: ""
      POSTGRES_USER: "postgres"
      POSTGRES_HOST_AUTH_METHOD: "trust"
