# Comments relates to Figma screen names.
# Names according to Figma. Suffix according to api list, details

type Token @entity {
  id: ID!  # Token Address
  symbol: String!
}


# ---- Core Contract ----
type Offer @entity {
  """Used in the next figma views:
    - Offer from List Of offers 1.2.
    - Offer 1.2
  """
  id: ID!  # Ref to offerId in contract.
  createdAt: BigInt!
  updatedAt: BigInt!
  provider: Bytes!
  pricePerEpoch: BigInt!
  paymentToken: Token!

  peers: [Peer!] @derivedFrom(field: "offer")
  effectors: [OfferEffector!] @derivedFrom(field: "offer")

  computeUnitsSum: Int  # Sum of all connected compute units.
}


"""To support many2many b/w offer and effector.
E.g. to use
{
  offers {
    effectors {
      effector {
        description
      }
    }
  }
}
"""
type OfferEffector @entity(immutable: true) {
    id: ID! # Set to `user.id.concat(organization.id)`
    offer: Offer!
    effector: Effector!
}


"Effector table is obsolete table since it is a simple mapping."
type Effector @entity(immutable: true) {
  "id and CID are the same."
  id: ID!  # Currently effector id is merged(prefix + hash) aka 1 CID.
  description: String!
  offers: [OfferEffector!] @derivedFrom(field: "effector")
}

type Peer @entity {
  "ref to peerId in contract."
  id: ID!
  offer: Offer!
  computeUnits: Int!
}

# ---- Deal Contract ----
type DealEffector @entity(immutable: true) {
    id: ID! # Set to `deal.id.concat(effector.id)`
    deal: Deal!
    effector: Effector!
}

type Deal @entity {
  id: ID!  # Ref to offerId in contract.
  createdAt: BigInt!
  client: Bytes!
  # Settings from public methods.
  minWorkers: Int!
  targetWorkers: Int!
  maxWorkersPerProvider: Int!
  paymentToken: Token!
  pricePerWorkerEpoch: BigInt!
  effectors: [DealEffector!] @derivedFrom(field: "deal")
  # TODO: add whitelists


#  balance: BigInt!  # on-request via frontend
#  status: DealStatus!  # on-request via frontend
  withdrawalSum: BigInt!
  depositedSum: BigInt!  # calculated from the withdraw() [no rewards withdraw].
  maxPaidEpoch: BigInt

  # If status active or cancelled.
  appCID: ID

#  TODO
  offer: Offer
}
